var RESULT={HIT:0,MISS:1,DODGE:2,CRIT:3,GLANCE:4},batching=0,step=0,log=!1,version=4;const TYPE={UPDATE:0,FINISHED:1,ERROR:2};class SimulationWorker{constructor(e,s,t){this.worker=new Worker("./dist/js/sim-worker.min.js"),this.worker.onerror=((...e)=>{t(...e),this.worker.terminate()}),this.worker.onmessage=(a=>{const[r,...i]=a.data;switch(r){case TYPE.UPDATE:s(...i);break;case TYPE.FINISHED:e(...i),this.worker.terminate();break;case TYPE.ERROR:t(...i),this.worker.terminate();break;default:t(`Unexpected type: ${r}`),this.worker.terminate()}})}start(e){e.globals=getGlobalsDelta(),this.worker.postMessage(e)}}class SimulationWorkerParallel{constructor(e,s,t,a){this.threads=e,this.callback_finished=s,this.callback_update=t,this.states=[...Array(this.threads)],this.workers=this.states.map((e,s)=>new SimulationWorker(e=>{this.states[s]={status:1,data:e},this.update()},(e,t)=>{this.states[s]={status:0,iteration:e,data:t},this.update()},e=>{this.error||(this.error=e,a(e))}))}update(){if(this.error)return;if(this.states.reduce((e,s)=>e+(s&&s.status||0),0)>=this.states.length){const e=this.states[0].data;this.states.slice(1).forEach(({data:s})=>{if(e.iterations+=s.iterations,e.totaldmg+=s.totaldmg,e.totalduration+=s.totalduration,e.mindps=Math.min(e.mindps,s.mindps),e.maxdps=Math.min(e.maxdps,s.maxdps),e.sumdps+=s.sumdps,e.sumdps2+=s.sumdps2,e.starttime=Math.min(e.starttime,s.starttime),e.endtime=Math.min(e.endtime,s.endtime),e.spread&&s.spread)for(let t in s.spread)e.spread[t]=(e.spread[t]||0)+s.spread[t];if(e.player&&s.player){for(let t in s.player.auras){const a=s.player.auras[t],r=e.player.auras[t];r?(r.uptime+=a.uptime,a.totaldmg&&(r.totaldmg=(r.totaldmg||0)+a.totaldmg)):e.player.auras[t]=a}for(let t in s.player.spells){const a=s.player.spells[t],r=e.player.spells[t];if(r){r.totaldmg+=a.totaldmg;for(let e=0;e<a.data.length;++e)r.data[e]+=a.data[e]}else e.player.spells[t]=a}function t(e,s){if(e){e.totaldmg+=s.totaldmg,e.totalprocdmg+=s.totalprocdmg;for(let t=0;t<s.data.length;++t)e.data[t]+=s.data[t];return e}return s}e.player.mh=t(e.player.mh,s.player.mh),s.player.oh&&(e.player.oh=t(e.player.oh,s.player.oh))}}),this.callback_finished(e)}else{let e=0;const s={iterations:this.iterations,totaldmg:0,totalduration:0};this.states.forEach(t=>{t&&(e+=t.status?t.data.iterations:t.iteration,s.totaldmg+=t.data.totaldmg,s.totalduration+=t.data.totalduration)}),this.callback_update(e,s)}}start(e){e.globals=getGlobalsDelta(),this.iterations=e.sim.iterations;let s=e.sim.iterations;this.workers.forEach((t,a)=>{const r=Math.round(s/(this.workers.length-a));s-=r,t.start({...e,sim:{...e.sim,iterations:r}})})}}class Simulation{static getConfig(){return{timesecsmin:parseInt($('input[name="timesecsmin"]').val()),timesecsmax:parseInt($('input[name="timesecsmax"]').val()),executeperc:parseInt($('input[name="executeperc"]').val()),startrage:parseInt($('input[name="startrage"]').val()),iterations:parseInt($('input[name="simulations"]').val()),priorityap:parseInt(spells[4].priorityap),batching:parseInt($('select[name="batching"]').val())}}constructor(e,s,t,a){a||(a=Simulation.getConfig()),this.player=e,this.timesecsmin=a.timesecsmin,this.timesecsmax=a.timesecsmax,this.executeperc=a.executeperc,this.startrage=a.startrage,this.iterations=a.iterations,batching=a.batching,this.idmg=0,this.totaldmg=0,this.totalduration=0,this.mindps=99999,this.maxdps=0,this.sumdps=0,this.sumdps2=0,this.maxcallstack=Math.min(Math.floor(this.iterations/10),1e3),this.starttime=0,this.endtime=0,this.cb_update=t,this.cb_finished=s,this.spread=[],this.priorityap=parseInt(spells[4].priorityap),log=1==this.iterations}startSync(){let e;for(this.starttime=(new Date).getTime(),e=1;e<=this.iterations;++e)this.run(),e%this.maxcallstack==0&&this.update(e);this.endtime=(new Date).getTime(),this.finished()}startAsync(){this.starttime=(new Date).getTime(),this.runAsync(1)}runAsync(e){this.run(),e==this.iterations?(this.endtime=(new Date).getTime(),this.finished()):e%this.maxcallstack==0?(this.update(e),setTimeout(()=>this.runAsync(e+1),0)):this.runAsync(e+1)}run(){step=0,this.idmg=0;let e,s,t=this.player;t.reset(this.startrage),this.maxsteps=rng(1e3*this.timesecsmin,1e3*this.timesecsmax),this.duration=this.maxsteps/1e3,this.executestep=this.maxsteps-parseInt(this.maxsteps*(this.executeperc/100));let a=!1,r=0,i=0;for(t.auras.flask&&(this.flaskstep=Math.max(this.maxsteps-6e4,0),i+=6e4),t.auras.cloudkeeper&&(this.cloudstep=Math.max(this.maxsteps-i-3e4,0),i+=3e4),t.auras.slayer&&(this.slayerstep=Math.max(this.maxsteps-i-2e4,0),i+=2e4),t.auras.spider&&(this.spiderstep=Math.max(this.maxsteps-i-15e3,0),i+=15e3),t.auras.gabbar&&(this.gabbarstep=Math.max(this.maxsteps-i-2e4,0),i+=2e4),t.auras.earthstrike&&(this.earthstep=Math.max(this.maxsteps-i-2e4,0),i+=2e4),t.auras.pummeler&&(this.pummelstep=Math.max(this.maxsteps-i-3e4,0),i+=3e4),t.auras.zandalarian&&(this.zandalarstep=Math.max(this.maxsteps-i-2e4,0),i+=2e4),t.auras.deathwish&&(t.auras.deathwish.usestep=Math.max(this.maxsteps-t.auras.deathwish.timetoend,0)),t.auras.recklessness&&(t.auras.recklessness.usestep=Math.max(this.maxsteps-t.auras.recklessness.timetoend,0)),t.auras.mightyragepotion&&(t.auras.mightyragepotion.usestep=Math.max(this.maxsteps-t.auras.mightyragepotion.timetoend,0)),t.auras.berserking&&(t.auras.berserking.usestep=Math.max(this.maxsteps-t.auras.berserking.timetoend,0)),t.auras.bloodfury&&(t.auras.bloodfury.usestep=Math.max(this.maxsteps-t.auras.bloodfury.timetoend,0)),t.auras.swarmguard&&(t.auras.swarmguard.usestep=Math.max(this.maxsteps-t.auras.swarmguard.timetoend,0)),t.auras.hategrips&&(t.auras.hategrips.usestep=Math.max(this.maxsteps-t.auras.hategrips.timetoend,0));step<this.maxsteps;)if(0!=r&&step%3e3==0&&t.talents.angermanagement&&(t.rage=t.rage>=99?100:t.rage+1,a=!0),t.vaelbuff&&0!=r&&step%1e3==0&&(t.rage=t.rage>=80?100:t.rage+20,a=!0),t.mh.timer<=0&&(this.idmg+=t.attackmh(t.mh),a=!0),t.oh&&t.oh.timer<=0&&(this.idmg+=t.attackoh(t.oh),a=!0),a&&!t.spelldelay&&(t.auras.swarmguard&&t.auras.swarmguard.canUse()?(t.spelldelay=1,e=t.auras.swarmguard):t.auras.hategrips&&t.auras.hategrips.canUse()?(t.spelldelay=1,e=t.auras.hategrips):t.auras.mightyragepotion&&t.auras.mightyragepotion.canUse()?(t.spelldelay=1,e=t.auras.mightyragepotion):t.spells.bloodrage&&t.spells.bloodrage.canUse()?(t.spelldelay=1,e=t.spells.bloodrage):t.timer||(t.auras.flask&&t.auras.flask.canUse()&&step>this.flaskstep?(t.spelldelay=1,e=t.auras.flask):t.auras.cloudkeeper&&t.auras.cloudkeeper.canUse()&&step>this.cloudstep?(t.spelldelay=1,e=t.auras.cloudkeeper):t.auras.recklessness&&t.auras.recklessness.canUse()?(t.spelldelay=1,e=t.auras.recklessness):t.auras.deathwish&&t.auras.deathwish.canUse()?(t.spelldelay=1,e=t.auras.deathwish):t.auras.bloodfury&&t.auras.bloodfury.canUse()?(t.spelldelay=1,e=t.auras.bloodfury):t.auras.berserking&&t.auras.berserking.canUse()?(t.spelldelay=1,e=t.auras.berserking):t.auras.slayer&&t.auras.slayer.canUse()&&step>this.slayerstep?(t.spelldelay=1,e=t.auras.slayer):t.auras.spider&&t.auras.spider.canUse()&&step>this.spiderstep?(t.spelldelay=1,e=t.auras.spider):t.auras.gabbar&&t.auras.gabbar.canUse()&&step>this.gabbarstep?(t.spelldelay=1,e=t.auras.gabbar):t.auras.earthstrike&&t.auras.earthstrike.canUse()&&step>this.earthstep?(t.spelldelay=1,e=t.auras.earthstrike):t.auras.pummeler&&t.auras.pummeler.canUse()&&step>this.pummelstep?(t.spelldelay=1,e=t.auras.pummeler):t.auras.zandalarian&&t.auras.zandalarian.canUse()&&step>this.zandalarstep?(t.spelldelay=1,e=t.auras.zandalarian):t.spells.execute&&step>=this.executestep?t.spells.bloodthirst&&t.stats.ap>=this.priorityap&&t.spells.bloodthirst.canUse()?(t.spelldelay=1,e=t.spells.bloodthirst):t.spells.mortalstrike&&t.stats.ap>=this.priorityap&&t.spells.mortalstrike.canUse()?(t.spelldelay=1,e=t.spells.mortalstrike):t.spells.execute.canUse()&&(t.spelldelay=1,e=t.spells.execute):t.spells.sunderarmor&&t.spells.sunderarmor.canUse()?(t.spelldelay=1,e=t.spells.sunderarmor):t.spells.bloodthirst&&t.spells.bloodthirst.canUse()?(t.spelldelay=1,e=t.spells.bloodthirst):t.spells.mortalstrike&&t.spells.mortalstrike.canUse()?(t.spelldelay=1,e=t.spells.mortalstrike):t.spells.whirlwind&&t.spells.whirlwind.canUse()?(t.spelldelay=1,e=t.spells.whirlwind):t.spells.overpower&&t.spells.overpower.canUse()?(t.spelldelay=1,e=t.spells.overpower):t.spells.hamstring&&t.spells.hamstring.canUse()&&(t.spelldelay=1,e=t.spells.hamstring)),t.heroicdelay&&(a=!1)),a&&!t.heroicdelay&&(!t.spells.execute||step<this.executestep?t.spells.heroicstrike&&t.spells.heroicstrike.canUse()&&(t.heroicdelay=1,s=t.spells.heroicstrike):t.spells.heroicstrikeexecute&&t.spells.heroicstrikeexecute.canUse()&&(t.heroicdelay=1,s=t.spells.heroicstrikeexecute),a=!1),t.spelldelay&&e&&t.spelldelay>e.maxdelay&&(t.heroicdelay&&s&&t.heroicdelay>s.maxdelay&&(t.heroicdelay=s.maxdelay-49),e.canUse()?(this.idmg+=t.cast(e),t.spelldelay=0,a=!0):t.spelldelay=0),t.heroicdelay&&s&&t.heroicdelay>s.maxdelay&&(s.canUse()?(t.cast(s),t.heroicdelay=0,a=!0):t.heroicdelay=0),t.spells.heroicstrike&&t.spells.heroicstrike.unqueue&&t.nextswinghs&&t.rage<t.spells.heroicstrike.unqueue&&t.mh.timer<=t.spells.heroicstrike.unqueuetimer&&(this.player.nextswinghs=!1),t.extraattacks>0&&(t.mh.timer=0,t.extraattacks--),t.batchedextras>0&&(t.mh.timer=batching-step%batching,t.batchedextras--),!t.mh.timer||!t.spelldelay&&a||!t.heroicdelay&&a)r=0;else{if(r=Math.min(t.mh.timer,t.oh?t.oh.timer:9999),t.spelldelay&&e.maxdelay-t.spelldelay<r&&(r=e.maxdelay-t.spelldelay+1),t.heroicdelay&&s.maxdelay-t.heroicdelay<r&&(r=s.maxdelay-t.heroicdelay+1),t.timer&&t.timer<r&&(r=t.timer),t.itemtimer&&t.itemtimer<r&&(r=t.itemtimer),t.talents.angermanagement&&3e3-step%3e3<r&&(r=3e3-step%3e3),t.vaelbuff&&1e3-step%1e3<r&&(r=1e3-step%1e3),t.auras.bloodrage&&t.auras.bloodrage.timer&&1e3-(step-t.auras.bloodrage.starttimer)%1e3<r&&(r=1e3-(step-t.auras.bloodrage.starttimer)%1e3),t.auras.gabbar&&t.auras.gabbar.timer&&2e3-(step-t.auras.gabbar.starttimer)%2e3<r&&(r=2e3-(step-t.auras.gabbar.starttimer)%2e3),t.spells.bloodthirst&&t.spells.bloodthirst.timer&&t.spells.bloodthirst.timer<r&&(r=t.spells.bloodthirst.timer),t.spells.mortalstrike&&t.spells.mortalstrike.timer&&t.spells.mortalstrike.timer<r&&(r=t.spells.mortalstrike.timer),t.spells.whirlwind&&t.spells.whirlwind.timer&&t.spells.whirlwind.timer<r&&(r=t.spells.whirlwind.timer),t.spells.bloodrage&&t.spells.bloodrage.timer&&t.spells.bloodrage.timer<r&&(r=t.spells.bloodrage.timer),t.spells.overpower&&t.spells.overpower.timer&&t.spells.overpower.timer<r&&(r=t.spells.overpower.timer),t.spells.execute&&t.spells.execute.timer&&t.spells.execute.timer<r&&(r=t.spells.execute.timer),t.spells.heroicstrike&&t.spells.heroicstrike.unqueue){let e=Math.max(t.mh.timer-t.spells.heroicstrike.unqueuetimer);e>0&&e<r&&(r=e)}step+=r,t.mh.step(r),t.oh&&t.oh.step(r),t.timer&&t.steptimer(r)&&!t.spelldelay&&(a=!0),t.itemtimer&&t.stepitemtimer(r)&&!t.spelldelay&&(a=!0),t.dodgetimer&&t.stepdodgetimer(r),t.spelldelay&&(t.spelldelay+=r),t.heroicdelay&&(t.heroicdelay+=r),t.spells.bloodthirst&&t.spells.bloodthirst.timer&&!t.spells.bloodthirst.step(r)&&!t.spelldelay&&(a=!0),t.spells.mortalstrike&&t.spells.mortalstrike.timer&&!t.spells.mortalstrike.step(r)&&!t.spelldelay&&(a=!0),t.spells.whirlwind&&t.spells.whirlwind.timer&&!t.spells.whirlwind.step(r)&&!t.spelldelay&&(a=!0),t.spells.bloodrage&&t.spells.bloodrage.timer&&!t.spells.bloodrage.step(r)&&!t.spelldelay&&(a=!0),t.spells.overpower&&t.spells.overpower.timer&&!t.spells.overpower.step(r)&&!t.spelldelay&&(a=!0),t.spells.execute&&t.spells.execute.timer&&!t.spells.execute.step(r)&&!t.spelldelay&&(a=!0),t.auras.bloodrage&&t.auras.bloodrage.timer&&!t.auras.bloodrage.step()&&!t.spelldelay&&(a=!0),t.auras.gabbar&&t.auras.gabbar.timer&&t.auras.gabbar.step()}t.endauras(),t.auras.deepwounds&&(this.idmg+=t.auras.deepwounds.idmg),this.totaldmg+=this.idmg,this.totalduration+=this.duration;let l=this.idmg/this.duration;l<this.mindps&&(this.mindps=l),l>this.maxdps&&(this.maxdps=l),this.sumdps+=l,this.sumdps2+=l*l,l=Math.round(l),this.spread[l]?this.spread[l]++:this.spread[l]=1}update(e){this.cb_update&&this.cb_update(e,{iterations:this.iterations,totaldmg:this.totaldmg,totalduration:this.totalduration})}finished(){this.cb_finished&&this.cb_finished({iterations:this.iterations,totaldmg:this.totaldmg,totalduration:this.totalduration,mindps:this.mindps,maxdps:this.maxdps,sumdps:this.sumdps,sumdps2:this.sumdps2,starttime:this.starttime,endtime:this.endtime})}}function rng(e,s){return~~(Math.random()*(s-e+1)+e)}function rng10k(){return~~(1e4*Math.random())}function avg(e,s){return(e+s)/2}